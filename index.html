<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Seoul Snow Trip 2026</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Varela Round', 'Noto Sans TC', sans-serif; 
            background-color: #F0F9FF;
            color: #334155;
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Day Card */
        .day-card { border-radius: 20px; transition: all 0.3s; }
        .day-card.active {
            background: white; border: 2px solid #38BDF8;
            box-shadow: 0 4px 8px rgba(186, 230, 253, 0.6);
            transform: translateY(-4px);
        }
        .day-card.inactive { color: #94A3B8; }

        .ticket-card { background: white; border: 2px dashed #BAE6FD; border-radius: 24px; }
        .spot-card { background: white; border-radius: 24px; box-shadow: 0 4px 15px rgba(186, 230, 253, 0.3); border: 1px solid white; }
        .action-btn { background: #F0F9FF; color: #0284C7; border-radius: 12px; font-weight: 600; font-size: 0.8rem; }
        
        .category-select {
            appearance: none; 
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230284C7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; 
            background-position: right 0.5rem center; 
            background-size: 0.8em; 
            padding-right: 1.5rem;
        }
        
        .currency-select-styled {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748B' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.3rem center;
            background-size: 0.7em;
            padding-right: 1.2rem;
            text-align: center;
        }

        .settlement-card {
            background: white;
            border: 2px dashed #7DD3FC;
            color: #334155;
            border-radius: 24px;
        }
        .exchange-rate-input {
            background: #F0F9FF;
            border: 1px solid #BAE6FD;
            color: #0284C7; text-align: center; border-radius: 8px;
        }
        
        .img-modal {
            position: fixed; inset: 0; z-index: 60; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="app" class="max-w-md mx-auto min-h-screen relative flex flex-col">

        <header class="pt-8 px-5 pb-2 flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold text-sky-500 tracking-tight">Seoul Go!</h1>
                <div class="mt-1 inline-block bg-sky-500 text-white text-[10px] px-3 py-1 rounded-full font-bold tracking-widest shadow-md transform -rotate-1">
                    æ™‚å…‰è† å›Š
                </div>
                <p class="text-[10px] text-slate-400 mt-1.5 font-medium tracking-wider pl-1">2026.01.30 - 02.05</p>
            </div>
            </header>

        <div v-if="currentTab === 'itinerary'" class="px-5 mt-4 overflow-x-auto hide-scrollbar flex space-x-3 pb-8 pt-4">
            <button @click="activeDay = -1" class="day-card flex-shrink-0 w-16 h-20 flex flex-col items-center justify-center" :class="activeDay === -1 ? 'active text-sky-600' : 'inactive bg-white/50'"><span class="text-xs font-bold uppercase tracking-widest">PRE</span><span class="text-xl">ğŸ“</span></button>
            <button v-for="(day, index) in days" :key="index" @click="activeDay = index" class="day-card flex-shrink-0 w-16 h-20 flex flex-col items-center justify-center" :class="activeDay === index ? 'active text-sky-600' : 'inactive bg-white/50'"><span class="text-[10px] font-bold uppercase text-slate-400 mb-0.5">DAY</span><span class="text-xl font-bold font-sans">{{ index + 1 }}</span><span class="text-[9px] font-medium mt-1 text-slate-400">{{ day.dateStr }}</span></button>
        </div>

        <main class="flex-1 px-5 space-y-5 overflow-y-auto hide-scrollbar mt-2">
            <transition name="fade" mode="out-in">
                
                <div v-if="currentTab === 'itinerary'" key="itinerary" class="space-y-5 pb-10">
                    <div v-if="activeDay === -1" class="space-y-3">
                        <div class="bg-white rounded-3xl p-6 shadow-sm border border-sky-100 text-center">
                            <h2 class="text-lg font-bold text-sky-500 mb-4">è¡Œå‰æº–å‚™ Check</h2>
                            <div class="space-y-4 text-left">
                                <div v-for="(todo, tIdx) in preTripTodos" :key="todo.id" class="bg-slate-50 rounded-xl p-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-bold text-slate-600">{{ todo.text }}</span>
                                        <button @click="removeTodo(tIdx)" class="text-slate-300 text-xs">âœ•</button>
                                    </div>
                                    <div class="flex justify-between items-center bg-white rounded-lg p-2 border border-slate-100">
                                        <div v-for="m in members" :key="m.id" @click="toggleTodoStatus(todo, m.id)" class="flex flex-col items-center cursor-pointer group">
                                            <div class="w-8 h-8 rounded-full border-2 transition-all overflow-hidden" :class="todo.completedBy.includes(m.id) ? 'border-green-400 ring-2 ring-green-100 opacity-100' : 'border-slate-100 opacity-30 grayscale'"><img :src="m.photo" class="w-full h-full object-cover"></div>
                                            <div class="h-3 mt-1"><span v-if="todo.completedBy.includes(m.id)" class="text-[10px] text-green-500 font-bold">âœ“</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 flex space-x-2"><input v-model="newTodo" placeholder="æ–°å¢äº‹é …..." class="flex-1 bg-slate-100 rounded-lg px-3 py-3 text-sm outline-none border border-transparent focus:border-sky-300 transition-all"><button @click="addTodo" class="bg-sky-400 text-white px-4 rounded-lg font-bold shadow-md active:scale-95 transition-transform">ï¼‹</button></div>
                        </div>
                    </div>
                    
                    <div v-if="activeDay >= 0" id="itinerary-list" class="space-y-4">
                        <div v-if="activeDay === 0" class="ticket-card p-5 relative">
                            <span class="absolute top-4 left-5 bg-sky-100 text-sky-600 text-[10px] px-3 py-1 rounded-full font-bold">å»ç¨‹</span>
                            <span class="absolute top-4 right-5 text-[10px] text-sky-500 font-bold tracking-widest">TPE â†’ ICN</span>
                            <div class="flex justify-between items-center mt-8 mb-2 px-2">
                                <div class="text-center"><div class="text-3xl font-black text-slate-700 tracking-wider">TPE</div><div class="text-xs text-slate-500 mt-2 bg-slate-100 px-3 py-1 rounded-full font-medium">20:00</div></div>
                                <div class="flex flex-col items-center flex-1 px-6 relative">
                                    <div class="mb-1 z-10"><svg class="w-6 h-6 text-sky-400" fill="currentColor" viewBox="0 0 24 24"><path d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z" transform="rotate(90 12 12)"/></svg></div>
                                    <div class="w-full h-0.5 bg-sky-200 relative flex items-center justify-between"><div class="w-2 h-2 bg-sky-400 rounded-full -ml-1"></div><div class="w-2 h-2 bg-sky-400 rounded-full -mr-1"></div></div>
                                    <span class="text-[10px] text-slate-400 mt-2 font-medium">IT 602</span>
                                </div>
                                <div class="text-center"><div class="text-3xl font-black text-slate-700 tracking-wider">ICN</div><div class="text-xs text-slate-500 mt-2 bg-slate-100 px-3 py-1 rounded-full font-medium">23:30</div></div>
                            </div>
                        </div>

                        <div v-if="activeDay === days.length - 1" class="ticket-card p-5 relative">
                            <span class="absolute top-4 left-5 bg-pink-100 text-pink-600 text-[10px] px-3 py-1 rounded-full font-bold">å›ç¨‹</span>
                            <span class="absolute top-4 right-5 text-[10px] text-sky-500 font-bold tracking-widest">ICN â†’ TPE</span>
                            <div class="flex justify-between items-center mt-8 mb-2 px-2">
                                <div class="text-center"><div class="text-3xl font-black text-slate-700 tracking-wider">ICN</div><div class="text-xs text-slate-500 mt-2 bg-slate-100 px-3 py-1 rounded-full font-medium">16:20</div></div>
                                <div class="flex flex-col items-center flex-1 px-6 relative">
                                    <div class="mb-1 z-10"><svg class="w-6 h-6 text-sky-400" fill="currentColor" viewBox="0 0 24 24"><path d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z" transform="rotate(90 12 12)"/></svg></div>
                                    <div class="w-full h-0.5 bg-sky-200 relative flex items-center justify-between"><div class="w-2 h-2 bg-sky-400 rounded-full -ml-1"></div><div class="w-2 h-2 bg-sky-400 rounded-full -mr-1"></div></div>
                                    <span class="text-[10px] text-slate-400 mt-2 font-medium">KE 2027</span>
                                </div>
                                <div class="text-center"><div class="text-3xl font-black text-slate-700 tracking-wider">TPE</div><div class="text-xs text-slate-500 mt-2 bg-slate-100 px-3 py-1 rounded-full font-medium">18:00</div></div>
                            </div>
                        </div>

                        <button @click="addSpot" class="w-full bg-amber-400 hover:bg-amber-300 text-white font-bold py-3 rounded-2xl shadow-sm flex items-center justify-center space-x-2 text-sm transition-transform active:scale-98">
                            <span class="bg-white/20 rounded-full w-5 h-5 flex items-center justify-center text-xs">ï¼‹</span><span>æ–°å¢ä¸€å€‹è¡Œç¨‹</span>
                        </button>

                        <div v-for="(spot, idx) in currentItinerary" :key="spot.id" :data-id="spot.id" class="spot-card p-4 relative group">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3 flex-1">
                                    <div class="handle text-slate-300 cursor-move py-1 px-1 hover:text-sky-400">â‹®â‹®</div>
                                    <div class="relative"><select v-model="spot.category" class="category-select bg-sky-50 text-sky-600 text-xs font-bold py-1.5 pl-3 pr-8 rounded-full outline-none border border-transparent focus:border-sky-300 cursor-pointer"><option value="æ™¯é»">ğŸ¡ æ™¯é»</option><option value="äº¤é€š">ğŸš‡ äº¤é€š</option><option value="èˆªç­">âœˆï¸ èˆªç­</option><option value="ç¾é£Ÿ">ğŸœ ç¾é£Ÿ</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="å¨›æ¨‚">ğŸ¢ å¨›æ¨‚</option><option value="å…¶ä»–">ğŸ”– å…¶ä»–</option></select></div>
                                </div>
                                <button @click="removeSpot(idx)" class="text-slate-200 hover:text-red-400 text-lg px-2">Ã—</button>
                            </div>
                            <div class="space-y-2 pl-1"><input v-model="spot.location" class="text-lg font-bold text-slate-700 w-full outline-none placeholder-slate-300 bg-transparent" placeholder="è¼¸å…¥åœ°é»åç¨±..."><input v-model="spot.note" class="text-xs text-slate-400 w-full outline-none placeholder-slate-200 bg-transparent" placeholder="âœ æ·»åŠ å‚™è¨»..."></div>
                            <div class="flex space-x-3 mt-4 pt-3 border-t border-slate-50"><button class="action-btn flex-1 py-2 flex items-center justify-center space-x-1 hover:bg-sky-100 transition-colors"><span>ğŸ—ºï¸</span> <span>åœ°åœ–</span></button><button class="action-btn flex-1 py-2 flex items-center justify-center space-x-1 bg-sky-50 text-sky-600 hover:bg-sky-100 transition-colors"><span>ğŸ“</span> <span>å°èˆª</span></button></div>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentTab === 'map'" key="map" class="h-[75vh] rounded-3xl overflow-hidden border-4 border-white shadow-lg relative"><div id="map" class="h-full w-full bg-slate-100"></div></div>

                <div v-else-if="currentTab === 'ledger'" key="ledger" class="space-y-6 pb-24">
                    <div class="bg-white rounded-3xl p-5 shadow-sm border border-sky-100">
                        <div class="flex justify-between items-center mb-3"><h2 class="text-sm font-bold text-slate-500">æˆå“¡è¨­å®š</h2><span class="text-[10px] text-sky-400 bg-sky-50 px-2 py-1 rounded-full">é»æ“Šé ­åƒæ›ç…§</span></div>
                        <div class="flex justify-between"><div v-for="m in members" :key="m.id" class="flex flex-col items-center w-14 group"><div @click="triggerUpload(m.id)" class="w-12 h-12 rounded-full border-2 border-slate-100 overflow-hidden cursor-pointer shadow-sm relative group-hover:border-sky-300 transition-all"><img :src="m.photo" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 hidden group-hover:flex items-center justify-center text-white text-[8px]">æ›´æ›</div><input :id="'file-'+m.id" type="file" class="hidden" @change="e => updatePhoto(e, m.id)"></div><input v-model="m.name" class="w-full text-center text-[10px] mt-1 text-slate-600 bg-transparent outline-none border-b border-transparent focus:border-sky-300"></div></div>
                    </div>

                    <div class="settlement-card p-6 shadow-sm relative overflow-hidden">
                        <div class="bg-sky-50 rounded-xl p-3 mb-5 border border-sky-100">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xs font-bold text-sky-600 flex items-center"><span>åŒ¯ç‡è¨­å®š (KRW âœ TWD)</span></h3>
                                <a href="https://rate.bot.com.tw/xrt?Lang=zh-TW" target="_blank" class="text-[10px] bg-sky-500 hover:bg-sky-400 px-3 py-1.5 rounded-full text-white flex items-center space-x-1 transition-colors shadow-sm"><span>ğŸ¦ æŸ¥çœ‹è‡ºéŠ€ç‰Œå‘ŠåŒ¯ç‡</span></a>
                            </div>
                            <div class="flex items-center space-x-2"><span class="text-xs text-slate-500">1 éŸ“å…ƒ â‰ˆ</span><input v-model.number="exchangeRate" type="number" step="0.0001" class="exchange-rate-input flex-1 py-1 px-2 outline-none focus:border-sky-400 transition-colors font-mono font-bold"><span class="text-xs text-slate-500">å°å¹£</span></div>
                        </div>
                        <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h2 class="text-sm font-bold tracking-widest text-slate-600">çµ±ä¸€çµç®—å ±è¡¨ (TWD)</h2></div>
                        <div v-if="settlements.length > 0" class="space-y-3 mb-6"><div v-for="(s, idx) in settlements" :key="idx" class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100"><div class="flex items-center space-x-2"><span class="text-xs font-bold text-red-400">{{ s.fromName }}</span><span class="text-[10px] text-slate-300">âœ</span><span class="text-xs font-bold text-green-500">{{ s.toName }}</span></div><div class="text-right"><span class="text-[9px] text-slate-400 block">æ‡‰ä»˜</span><span class="font-mono font-bold text-sky-500 text-sm">NT$ {{ s.amount.toLocaleString() }}</span></div></div></div>
                        <div v-else class="text-center text-xs text-slate-400 py-4">ç›®å‰æ²’æœ‰éœ€è¦çµç®—çš„æ¬¾é … ğŸ‰</div>

                        <div class="mt-4 pt-4 border-t border-slate-100">
                            <h3 class="text-[10px] font-bold text-slate-400 mb-3 text-center">å€‹äººç¸½èŠ±è²» (é»æ“Šé ­åƒçœ‹æ˜ç´°)</h3>
                            <div class="flex justify-between items-start space-x-2 px-1">
                                <div v-for="summary in memberSummaries" :key="summary.id" @click="openMemberDetail(summary)" class="flex flex-col items-center flex-shrink-0 w-16 group cursor-pointer transition-transform active:scale-95">
                                    <div class="w-10 h-10 rounded-full border border-slate-200 overflow-hidden mb-1 group-hover:border-sky-400 group-hover:shadow-md transition-all"><img :src="summary.photo" class="w-full h-full object-cover"></div><span class="text-[9px] text-slate-500 mb-0.5 truncate w-full text-center group-hover:text-sky-500">{{ summary.name }}</span><span class="text-[10px] font-mono font-bold text-sky-600 bg-sky-50 px-1.5 py-0.5 rounded-full group-hover:bg-sky-100">${{ Math.round(summary.spent).toLocaleString() }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button @click="addExpense" class="w-full bg-amber-400 hover:bg-amber-300 text-white font-bold py-3 rounded-2xl shadow-sm flex items-center justify-center space-x-2 text-sm transition-transform active:scale-98">
                        <span class="bg-white/20 rounded-full w-5 h-5 flex items-center justify-center text-xs">ï¼‹</span><span>æ–°å¢ä¸€ç­†æ”¯å‡º</span>
                    </button>

                    <div class="space-y-2 pb-2">
                        <div class="flex justify-between items-end px-2"><h2 class="text-sky-500 font-bold tracking-widest">EXPENSE LIST</h2><span class="text-[10px] text-slate-400">ä¾æ—¥æœŸæ’åº (æœ€æ–°åœ¨å‰)</span></div>
                        <transition-group name="list" tag="div" class="space-y-4">
                            <div class="bg-white rounded-3xl p-5 shadow-sm border border-white space-y-4" v-for="exp in sortedExpenses" :key="exp.id">
                                
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <div class="relative flex-shrink-0 h-8">
                                            <select v-model="exp.category" class="category-select h-full bg-sky-50 text-sky-600 text-[10px] font-bold pl-3 pr-8 rounded-full outline-none border border-transparent focus:border-sky-300 cursor-pointer">
                                                <option v-for="cat in categories" :value="cat.name">{{ cat.icon }} {{ cat.name }}</option>
                                            </select>
                                        </div>
                                        <button @click="promptAddCategory" class="h-8 w-8 flex items-center justify-center text-[12px] text-slate-300 hover:text-sky-400 bg-slate-50 rounded-full hover:bg-sky-50 transition-colors">ï¼‹</button>
                                        <div class="h-8 flex items-center bg-slate-50 rounded-lg px-2">
                                            <select v-model="exp.date" class="bg-transparent text-slate-500 text-[10px] font-bold outline-none"><option v-for="d in days" :value="d.full">{{ d.dateStr }}</option></select>
                                        </div>
                                    </div>
                                    <div class="h-8 flex items-center bg-slate-50 rounded-lg px-2">
                                        <input type="time" v-model="exp.time" class="bg-transparent text-slate-400 text-[10px] outline-none text-right">
                                    </div>
                                </div>
                                
                                <input v-model="exp.item" class="w-full font-bold text-slate-700 outline-none border-b border-transparent focus:border-slate-200 transition-colors py-1" placeholder="è«‹è¼¸å…¥æ”¯å‡ºé …ç›®...">
                                
                                <div class="flex items-center justify-between mt-1">
                                    <div class="flex items-center bg-slate-50 rounded-full pl-2 pr-2 py-1 border border-slate-100 flex-shrink-0 h-9">
                                        <span class="text-[9px] text-slate-400 mr-1 whitespace-nowrap">ä»˜æ¬¾äºº</span>
                                        <select v-model="exp.payerId" class="bg-transparent text-xs font-bold text-slate-600 outline-none w-16 text-center cursor-pointer">
                                            <option v-for="m in members" :value="m.id">{{ m.name }}</option>
                                        </select>
                                    </div>
                                    
                                    <div class="flex items-center space-x-2 h-9">
                                        <select v-model="exp.currency" class="currency-select-styled h-full bg-white border border-slate-200 rounded-lg pl-2 text-xs font-bold text-slate-500 outline-none focus:border-sky-300 cursor-pointer">
                                            <option value="KRW">KRW</option>
                                            <option value="TWD">TWD</option>
                                        </select>
                                        <input v-model.number="exp.amount" type="number" class="h-full w-32 text-right text-3xl font-black text-sky-500 outline-none placeholder-sky-100 bg-transparent" placeholder="0">
                                    </div>
                                </div>
                                <div v-if="exp.currency === 'KRW'" class="text-right text-[10px] text-slate-400 -mt-2 mb-1">â‰ˆ NT$ {{ Math.round(exp.amount * exchangeRate).toLocaleString() }}</div>
                                
                                <div class="flex items-center space-x-2 mt-2">
                                    <input v-model="exp.note" class="flex-1 bg-slate-50 rounded-lg px-3 py-2 text-xs text-slate-500 outline-none placeholder-slate-300" placeholder="æ·»åŠ å‚™è¨»...">
                                    <div class="relative group">
                                        <button @click="triggerReceiptUpload(exp.id)" class="bg-slate-100 p-2 rounded-lg text-slate-400 hover:text-sky-500 hover:bg-sky-50 transition-colors">
                                            <span v-if="!exp.receipt">ğŸ“·</span>
                                            <div v-else class="relative">
                                                <img :src="exp.receipt" class="w-6 h-6 object-cover rounded-sm border border-slate-200 shadow-sm">
                                                <div class="absolute inset-0 bg-black/10 rounded-sm group-hover:bg-black/20 transition-colors"></div>
                                            </div>
                                        </button>
                                        <input :id="'receipt-'+exp.id" type="file" class="hidden" accept="image/*" @change="e => updateReceipt(e, exp.id)">
                                        <button v-if="exp.receipt" @click.stop="previewReceipt(exp.receipt)" class="absolute -top-2 -right-2 bg-slate-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[8px] shadow-sm z-10">ğŸ”</button>
                                    </div>
                                </div>

                                <div class="flex gap-2 justify-end pt-2 border-t border-slate-50 mt-2">
                                    <div v-for="m in members" :key="m.id" @click="toggleParticipant(exp, m.id)" class="w-8 h-8 rounded-full border-2 overflow-hidden transition-all cursor-pointer relative" :class="exp.participants.includes(m.id) ? 'border-sky-400 opacity-100 scale-105 shadow-md' : 'border-slate-100 opacity-30 grayscale scale-95'"><img :src="m.photo" class="w-full h-full object-cover"><div v-if="!exp.participants.includes(m.id)" class="absolute inset-0 bg-white/50"></div></div>
                                </div>
                            </div>
                        </transition-group>
                    </div>
                </div>
            </transition>
        </main>

        <nav class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 bg-white rounded-full shadow-xl p-2 flex items-center space-x-1 mb-2 safe-bottom w-[90%] max-w-sm justify-between">
            <button @click="currentTab = 'itinerary'" :class="currentTab === 'itinerary' ? 'text-sky-500' : 'text-slate-400'" class="flex-1 flex flex-col items-center py-1 px-2 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span class="text-[10px] font-medium">è¡Œç¨‹</span></button>
            <button class="flex-1 flex flex-col items-center py-1 px-2 rounded-full text-slate-300 cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg><span class="text-[10px] font-medium">å¤©æ°£</span></button>
            <button @click="currentTab = 'ledger'" :class="currentTab === 'ledger' ? 'text-sky-500' : 'text-slate-400'" class="flex-1 flex flex-col items-center py-1 px-2 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span class="text-[10px] font-medium">è¨˜å¸³</span></button>
            <button @click="showShoppingModal = true" class="flex-1 flex flex-col items-center py-1 px-2 rounded-full text-slate-400 hover:text-sky-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg><span class="text-[10px] font-medium">è³¼ç‰©</span></button>
            <button @click="currentTab = 'map'" :class="currentTab === 'map' ? 'text-sky-500' : 'text-slate-400'" class="flex-1 flex flex-col items-center py-1 px-2 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 7m0 13V7" /></svg><span class="text-[10px] font-medium">æŒ‡å—</span></button>
        </nav>

        <div v-if="showShoppingModal" class="fixed inset-0 z-50 bg-sky-900/30 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl flex flex-col max-h-[70vh]">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-slate-700 tracking-wide">SHOPPING LIST</h3><button @click="showShoppingModal = false" class="text-slate-300 text-xl">âœ•</button></div>
                <div class="mb-4 pb-2 border-b border-slate-50">
                    <div class="flex justify-between items-start px-1">
                        <div v-for="m in members" :key="m.id" @click="activeShopMember = m.id" class="flex flex-col items-center cursor-pointer transition-all relative w-12 group">
                            <div class="w-10 h-10 rounded-full border-2 overflow-hidden transition-all" :class="activeShopMember === m.id ? 'border-sky-400 scale-110 shadow-md ring-2 ring-sky-100' : 'border-slate-100 opacity-60 grayscale'">
                                <img :src="m.photo" class="w-full h-full object-cover">
                            </div>
                            <div v-if="getMemberPendingCount(m.id) > 0" class="absolute -top-1 -right-1 bg-red-400 text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center border-2 border-white">{{ getMemberPendingCount(m.id) }}</div>
                            <span class="text-[9px] mt-1 font-bold truncate w-full text-center" :class="activeShopMember === m.id ? 'text-sky-500' : 'text-slate-300'">{{ m.name }}</span>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto space-y-2 mb-4 hide-scrollbar"><div v-if="currentMemberShoppingList.length === 0" class="text-center py-8 text-slate-300 text-xs">å°šç„¡ {{ members.find(m => m.id === activeShopMember)?.name }} çš„æ¸…å–®</div><div v-for="(item, idx) in currentMemberShoppingList" :key="item.id" class="flex items-center space-x-3 group"><input type="checkbox" v-model="item.done" class="rounded text-sky-400 focus:ring-sky-300 w-5 h-5 border-slate-300"><input v-model="item.text" class="flex-1 outline-none text-sm border-b border-transparent focus:border-slate-200 py-1 transition-colors bg-transparent text-slate-600 font-medium" :class="{'line-through text-slate-300': item.done}"><button @click="removeShopItem(item.id)" class="text-red-200 hover:text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">Ã—</button></div></div>
                <div class="flex space-x-2 mt-auto"><input v-model="newShopItem" :placeholder="`å¹« ${members.find(m => m.id === activeShopMember)?.name} æ–°å¢...`" @keyup.enter="addShopItem" class="flex-1 bg-slate-50 px-4 py-3 rounded-2xl text-sm outline-none border border-transparent focus:border-sky-200 transition-all"><button @click="addShopItem" class="bg-sky-400 text-white px-4 rounded-2xl font-bold shadow-lg shadow-sky-200/50 active:scale-95 transition-transform">ï¼‹</button></div>
            </div>
        </div>

        <div v-if="showMemberDetailModal" class="fixed inset-0 z-50 bg-slate-800/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative max-h-[80vh] flex flex-col">
                <button @click="showMemberDetailModal = false" class="absolute top-4 right-4 text-slate-400 text-xl">âœ•</button>
                <div class="text-center mb-6"><div class="w-16 h-16 rounded-full border-2 border-sky-100 mx-auto overflow-hidden mb-2 shadow-sm"><img :src="selectedMember?.photo" class="w-full h-full object-cover"></div><h3 class="text-lg font-bold text-slate-700">{{ selectedMember?.name }} çš„æ¶ˆè²»æ˜ç´°</h3><p class="text-xs text-sky-500 font-mono mt-1">ç¸½è¨ˆ: NT$ {{ Math.round(selectedMemberTotal).toLocaleString() }}</p></div>
                <div class="flex-1 overflow-y-auto space-y-3 hide-scrollbar">
                    <div v-for="exp in selectedMemberExpenses" :key="exp.id" class="flex justify-between items-start border-b border-slate-50 pb-2">
                        <div><div class="text-xs font-bold text-slate-600">{{ exp.item }}</div><div class="text-[10px] text-slate-400">{{ exp.date }} Â· {{ exp.time }} Â· {{ exp.category }}</div></div>
                        <div class="text-right"><div class="text-xs font-bold text-slate-700">NT$ {{ Math.round(getShareAmount(exp)).toLocaleString() }}</div><div v-if="exp.currency === 'KRW'" class="text-[9px] text-slate-300">(â‚© {{ Math.round(exp.amount / exp.participants.length).toLocaleString() }})</div></div>
                    </div>
                    <div v-if="selectedMemberExpenses.length === 0" class="text-center text-xs text-slate-300 py-10">æš«ç„¡æ¶ˆè²»ç´€éŒ„</div>
                </div>
            </div>
        </div>

        <div v-if="previewImageUrl" class="img-modal" @click="previewImageUrl = null">
            <img :src="previewImageUrl" class="max-w-[90%] max-h-[90%] rounded-lg shadow-2xl">
        </div>

    </div>

    <script>
        const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const activeDay = ref(0);
                const showShoppingModal = ref(false);
                const activeShopMember = ref(1);
                const exchangeRate = ref(0.0245); 
                const showMemberDetailModal = ref(false);
                const selectedMemberId = ref(null);
                const previewImageUrl = ref(null);
                
                const categories = ref([
                    { name: 'é£²é£Ÿ', icon: 'ğŸœ' },
                    { name: 'ä½å®¿', icon: 'ğŸ¨' },
                    { name: 'äº¤é€š', icon: 'ğŸš‡' },
                    { name: 'è³¼ç‰©', icon: 'ğŸ›ï¸' },
                    { name: 'å¨›æ¨‚', icon: 'ğŸ¡' },
                    { name: 'å…¶ä»–', icon: 'ğŸ”–' }
                ]);

                const days = [{ dateStr: '1/30', full: '2026-01-30' }, { dateStr: '1/31', full: '2026-01-31' }, { dateStr: '2/01', full: '2026-02-01' }, { dateStr: '2/02', full: '2026-02-02' }, { dateStr: '2/03', full: '2026-02-03' }, { dateStr: '2/04', full: '2026-02-04' }, { dateStr: '2/05', full: '2026-02-05' }];
                const itineraries = ref({ 0: [{ id: 1, category: 'ä½å®¿', location: 'Momoho Hongdae', note: '' }] });
                const currentItinerary = computed(() => { if (!itineraries.value[activeDay.value]) itineraries.value[activeDay.value] = []; return itineraries.value[activeDay.value]; });
                const addSpot = () => { const id = Date.now(); currentItinerary.value.push({ id, category: 'æ™¯é»', location: '', note: '' }); nextTick(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' })); };
                const removeSpot = (idx) => currentItinerary.value.splice(idx, 1);
                const initSortable = () => { const el = document.getElementById('itinerary-list'); if(el) Sortable.create(el, { handle: '.handle', animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag' }); };

                const preTripTodos = ref([{ id: 1, text:'è³¼è²· T-Money å¡', completedBy: [] }, { id: 2, text:'ä¸‹è¼‰ Naver Map', completedBy: [] }]);
                const newTodo = ref('');
                const addTodo = () => { if(newTodo.value) { preTripTodos.value.push({ id: Date.now(), text: newTodo.value, completedBy: [] }); newTodo.value=''; }};
                const removeTodo = (idx) => preTripTodos.value.splice(idx, 1);
                const toggleTodoStatus = (todo, memberId) => { const idx = todo.completedBy.indexOf(memberId); if (idx > -1) todo.completedBy.splice(idx, 1); else todo.completedBy.push(memberId); };

                const shoppingList = ref([{ id: 1, text: 'Olive Young é¢è†œ', done: false, ownerId: 1 }, { id: 2, text: 'Gentle Monster å¢¨é¡', done: false, ownerId: 1 }]);
                const newShopItem = ref('');
                const currentMemberShoppingList = computed(() => shoppingList.value.filter(item => item.ownerId === activeShopMember.value));
                const addShopItem = () => { if (newShopItem.value) { shoppingList.value.push({ id: Date.now(), text: newShopItem.value, done: false, ownerId: activeShopMember.value }); newShopItem.value = ''; }};
                const removeShopItem = (id) => { const idx = shoppingList.value.findIndex(i => i.id === id); if (idx > -1) shoppingList.value.splice(idx, 1); };
                const getMemberPendingCount = (memberId) => shoppingList.value.filter(i => i.ownerId === memberId && !i.done).length;
                const totalShoppingCount = computed(() => shoppingList.value.filter(i => !i.done).length);

                const members = ref([
                    { id: 1, name: 'æˆ‘', photo: 'https://i.pravatar.cc/150?u=1' },
                    { id: 2, name: 'æ—…ä¼´A', photo: 'https://i.pravatar.cc/150?u=2' },
                    { id: 3, name: 'æ—…ä¼´B', photo: 'https://i.pravatar.cc/150?u=3' },
                    { id: 4, name: 'æ—…ä¼´C', photo: 'https://i.pravatar.cc/150?u=4' },
                    { id: 5, name: 'æ—…ä¼´D', photo: 'https://i.pravatar.cc/150?u=5' }
                ]);
                const triggerUpload = (id) => document.getElementById(`file-${id}`).click();
                const updatePhoto = (e, id) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (evt) => { const m = members.value.find(x => x.id === id); if(m) m.photo = evt.target.result; }; reader.readAsDataURL(file); } };

                const expenses = ref([{ id: 1700000000000, date: '2026-01-30', time: '18:30', category: 'é£²é£Ÿ', item: 'ç¬¬ä¸€é¤çƒ¤è‚‰', amount: 85000, currency: 'KRW', payerId: 1, participants: [1,2,3,4,5], note: '', receipt: null }]);
                const sortedExpenses = computed(() => { return [...expenses.value].sort((a, b) => { if (a.date < b.date) return 1; if (a.date > b.date) return -1; return b.id - a.id; }); });
                
                const addExpense = () => { 
                    const now = new Date();
                    const timeStr = now.toTimeString().slice(0,5);
                    expenses.value.push({ id: Date.now(), date: days[0].full, time: timeStr, category: 'é£²é£Ÿ', item: '', amount: null, currency: 'KRW', payerId: 1, participants: [1, 2, 3, 4, 5], note: '', receipt: null }); 
                };
                
                const promptAddCategory = () => { const newCat = prompt("è«‹è¼¸å…¥æ–°åˆ†é¡åç¨±:"); if(newCat && !categories.value.find(c=>c.name===newCat)) { categories.value.push({ name: newCat, icon: 'ğŸ”–' }); } };
                const toggleParticipant = (exp, uid) => { const idx = exp.participants.indexOf(uid); idx > -1 ? exp.participants.splice(idx,1) : exp.participants.push(uid); };

                const triggerReceiptUpload = (id) => document.getElementById(`receipt-${id}`).click();
                const updateReceipt = (e, id) => { 
                    const file = e.target.files[0]; 
                    if(file) { 
                        const reader = new FileReader(); 
                        reader.onload = (evt) => { 
                            const exp = expenses.value.find(x => x.id === id); 
                            if(exp) exp.receipt = evt.target.result; 
                        }; 
                        reader.readAsDataURL(file); 
                    } 
                };
                const previewReceipt = (url) => { previewImageUrl.value = url; };

                const getUnifiedBalances = () => {
                    const balances = {};
                    members.value.forEach(m => balances[m.id] = 0);
                    expenses.value.filter(e => e.amount).forEach(exp => {
                        const amountInTwd = exp.currency === 'KRW' ? (exp.amount * exchangeRate.value) : exp.amount;
                        const splitAmount = amountInTwd / exp.participants.length;
                        if (balances[exp.payerId] !== undefined) balances[exp.payerId] += amountInTwd;
                        exp.participants.forEach(pid => { if (balances[pid] !== undefined) balances[pid] -= splitAmount; });
                    });
                    return balances;
                };

                const settlements = computed(() => {
                    const bal = getUnifiedBalances();
                    let debtors = [], creditors = [];
                    for (const [id, amount] of Object.entries(bal)) {
                        if (amount < -1) debtors.push({ id: parseInt(id), amount: amount });
                        if (amount > 1) creditors.push({ id: parseInt(id), amount: amount });
                    }
                    debtors.sort((a, b) => a.amount - b.amount);
                    creditors.sort((a, b) => b.amount - a.amount);
                    const result = []; let i = 0; let j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        const debtor = debtors[i]; const creditor = creditors[j];
                        const amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                        result.push({ from: debtor.id, to: creditor.id, fromName: members.value.find(m => m.id === debtor.id)?.name, toName: members.value.find(m => m.id === creditor.id)?.name, amount: Math.round(amount) });
                        debtor.amount += amount; creditor.amount -= amount;
                        if (Math.abs(debtor.amount) < 1) i++; if (creditor.amount < 1) j++;
                    }
                    return result;
                });

                const memberSummaries = computed(() => {
                    return members.value.map(m => {
                        let spent = 0;
                        expenses.value.filter(e => e.amount).forEach(exp => {
                            const amountInTwd = exp.currency === 'KRW' ? (exp.amount * exchangeRate.value) : exp.amount;
                            if (exp.participants.includes(m.id)) spent += (amountInTwd / exp.participants.length);
                        });
                        return { id: m.id, name: m.name, photo: m.photo, spent: spent };
                    });
                });

                const openMemberDetail = (member) => { selectedMemberId.value = member.id; showMemberDetailModal.value = true; };
                const selectedMember = computed(() => members.value.find(m => m.id === selectedMemberId.value));
                const selectedMemberExpenses = computed(() => {
                    if (!selectedMemberId.value) return [];
                    return sortedExpenses.value.filter(exp => exp.participants.includes(selectedMemberId.value));
                });
                const getShareAmount = (exp) => { const amountInTwd = exp.currency === 'KRW' ? (exp.amount * exchangeRate.value) : exp.amount; return amountInTwd / exp.participants.length; };
                const selectedMemberTotal = computed(() => selectedMemberExpenses.value.reduce((sum, exp) => sum + getShareAmount(exp), 0));

                let map;
                const initMap = () => { if(map) return; map = L.map('map').setView([37.5665, 126.9780], 13); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map); };
                watch(currentTab, (val) => { if(val === 'itinerary') nextTick(initSortable); if(val === 'map') nextTick(initMap); });
                watch(activeDay, () => { if(currentTab.value === 'itinerary') nextTick(initSortable); });
                onMounted(() => { initSortable(); });

                return {
                    currentTab, activeDay, days, itineraries, currentItinerary,
                    preTripTodos, newTodo, addTodo, removeTodo, toggleTodoStatus, 
                    showShoppingModal, activeShopMember, currentMemberShoppingList, newShopItem, addShopItem, removeShopItem, getMemberPendingCount, totalShoppingCount,
                    addSpot, removeSpot, members, triggerUpload, updatePhoto, expenses, sortedExpenses, addExpense, toggleParticipant,
                    exchangeRate, settlements, memberSummaries,
                    categories, promptAddCategory, showMemberDetailModal, openMemberDetail, selectedMember, selectedMemberExpenses, getShareAmount, selectedMemberTotal,
                    triggerReceiptUpload, updateReceipt, previewReceipt, previewImageUrl
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
